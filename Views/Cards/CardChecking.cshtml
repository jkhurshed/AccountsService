<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма оплаты картой</title>
    <link rel="stylesheet" href="~/css/CardCheckingStyle.css" />
</head>
<body>
<div class="card-form">
    <div class="form-group">
        <label for="PanNumber">Номер карты</label>
        <div class="card-icon">
            <input
                    type="text"
                    id="PanNumber"
                    class="card-number-input"
                    placeholder="**** **** **** ****"
                    maxlength="19"
            >
            <div class="card-visual">
                <div class="card-chip"></div>
                <div class="card-stripe"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="expiry-group">
            <label>Срок действия</label>
            <div class="expiry-inputs">
                <input
                    type="text"
                    placeholder="MM"
                    maxlength="2"
                    id="expMonth"
                >
                <input
                    type="text"
                    placeholder="ГГ"
                    maxlength="2"
                    id="expYear"
                >
            </div>
        </div>

        <div class="cvc-group">
            <label for="cvc">Код проверки</label>
            <input
                type="text"
                id="cvc"
                placeholder="CVC"
                maxlength="3"
            >
        </div>
    </div>

    <div class="form-group">
        <label for="cardHolder">Имя и фамилия владельца карты</label>
        <input
            type="text"
            id="cardHolder"
            class="holder-input"
            placeholder="CARD HOLDER"
        >
    </div>
</div>

<script>
    const panNumber = document.getElementById('PanNumber');
    const expMonth = document.getElementById('expMonth');
    const expYear = document.getElementById('expYear');
    const cvc = document.getElementById('cvc');
    const cardHolder = document.getElementById('cardHolder');

    let timeout = null;

    function sendCardData() {
        const data = {
            panNumber: panNumber.value,
            expMonth: expMonth.value,
            expYear: expYear.value,
            cardHolder: cardHolder.value
        };

        // Send it to a specific parent origin (TransferService)
        console.log("Sending data to parent:", data);   
        window.parent.postMessage(data, "http://localhost:5104");
    }

    // Whenever any input changes, send updated data
    [panNumber, expMonth, expYear, cardHolder].forEach(el => {
        el.addEventListener('input', sendCardData);
    });
    
    // Track if user has interacted with each field
    const userInteracted = {
        panNumber: false,
        expMonth: false,
        expYear: false,
        cvc: false
    };

    panNumber.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;

        clearTimeout(timeout);

        if (value.length >= 16) { // check only when full number entered
            timeout = setTimeout(() => checkCard(value), 500);
        }
        
        // Mark as interacted and validate
        userInteracted.panNumber = true;
        validateField(panNumber, value.length === 16);
    });

    async function checkCard(panNumber) {
        try {
            // Format the PAN with hyphens for the API request
            const formattedPan = panNumber.replace(/(\d{4})/g, '$1-').replace(/-$/, '');

            const response = await fetch(`/api/Cards/by-pan/${formattedPan}`);
            if (response.ok) {
                const card = await response.json();
                showCardInfo(card);
            } else {
                showNotFound();
            }
        } catch (error) {
            console.error('Error fetching card info:', error);
        }
    }

    function showCardInfo(card) {
        console.log('Card found:', card);
        panNumber.classList.remove('invalid');
        panNumber.classList.add('valid');
    }

    function showNotFound() {
        console.log('Card not found');
        panNumber.classList.remove('valid');
        panNumber.classList.add('invalid');
    }

    expMonth.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        if (e.target.value.length === 2 && parseInt(e.target.value) > 12) {
            e.target.value = '12';
        }
        
        // Mark as interacted and validate
        userInteracted.expMonth = true;
        validateExpMonth();
        validateExpYear(); // Also validate year when month changes for complete expiry check
    });

    expYear.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        
        // Mark as interacted and validate
        userInteracted.expYear = true;
        validateExpYear();
    });

    cvc.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        
        // Mark as interacted and validate
        userInteracted.cvc = true;
        validateField(cvc, e.target.value.length === 3);
    });

    // Add blur event listeners for additional validation
    expMonth.addEventListener('blur', function(e) {
        userInteracted.expMonth = true;
        validateExpMonth();
        validateExpYear();
    });

    expYear.addEventListener('blur', function(e) {
        userInteracted.expYear = true;
        validateExpYear();
    });

    cvc.addEventListener('blur', function(e) {
        userInteracted.cvc = true;
        validateField(cvc, e.target.value.length === 3);
    });

    // Validation functions
    function validateExpMonth() {
        const isValid = parseInt(expMonth.value) >= 1 && 
                        parseInt(expMonth.value) <= 12;
        validateField(expMonth, isValid);
        return isValid;
    }

    function validateExpYear() {
        const currentYear = new Date().getFullYear() % 100; // Get last 2 digits (YY)
        const currentMonth = new Date().getMonth() + 1; // Get the current month (1-12)
        
        const yearValue = parseInt(expYear.value);
        const monthValue = parseInt(expMonth.value);
        
        let isValid = expYear.value.length === 2;
        
        if (isValid) {
            // Check if year is in the future
            if (yearValue < currentYear) {
                isValid = false; // Year is in the past
            } 
            // If current year, check if month is in the future
            else if (yearValue === currentYear && monthValue < currentMonth) {
                isValid = false; // Month is in the past for current year
            }
        }
        
        validateField(expYear, isValid);
        return isValid;
    }

    function validateField(field, isValid) {
        const fieldName = field.id === 'PanNumber' ? 'panNumber' : 
                         field.id === 'expMonth' ? 'expMonth' :
                         field.id === 'expYear' ? 'expYear' : 'cvc';
        
        // Only apply validation styles if user has interacted with this field
        if (userInteracted[fieldName]) {
            if (isValid) {
                field.classList.remove('invalid');
                field.classList.add('valid');
            } else {
                field.classList.remove('valid');
                field.classList.add('invalid');
            }
        } else {
            // Remove both classes if no interaction yet
            field.classList.remove('invalid', 'valid');
        }
    }
</script>
</body>
</html>